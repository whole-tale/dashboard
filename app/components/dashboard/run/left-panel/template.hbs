<div class="wt panel manage">
    <div class="wt paddleboard">
        <h2>
            <img src="/images/wholetale_logo_sm.png" /> Current Tale
            {{#if hasSelectedTaleInstance}}
                <i class="fas fa-expand right floated" style="cursor: pointer;" {{action 'toggleFullscreen'}}></i>
            {{/if}}
            {{#if (and (not-eq model.status 0) (and model.iframe (eq internalState.currentInstanceId model._id)))}}
                <a href="{{model.url}}" target="_blank">
                    <i class="external alternate right icon" style="cursor: pointer; padding-right: 0.3em; bottom: 4px"></i>
                </a>
            {{/if}}
        </h2>
    </div>
    {{#unless noInstanceSelected}}
        <div class="wt paddleboard tall header">
            <div class="ui bordlerless menu">
                <div class="item">
                    <img class="illustration" src="{{model.tale.illustration}}" />
                    <img class="env" src="{{model.tale.icon}}" />
                    <div class="header name">
                        <h3>{{model.name}}</h3>
                        <span>{{model.tale.authors}}</span>
                    </div>
                </div>
                <div class="right borderless menu">
                    <div class="item">
                        <div class="ui basic blue button" {{action (route-action 'showModal' 'ui/files/publish-modal' publishModalContext )}}>
                            Publish Tale
                        </div>
                    </div>
                    <div class="item">
                        <div class="ui blue button" {{action "editTaleInfo" model._id}}>
                            Edit Tale Info
                        </div>
                    </div>
                    <div class="item">
                        <a href="https://wholetale.readthedocs.io/users_guide/run.html">
                            <i class="fas fa-info" style="cursor: pointer;"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {{/unless}}
    {{!-- {{#if (eq internalState.currentInstanceId model._id)}} --}}
    {{#if hasSelectedTaleInstance}}
        
        <div class="ui secondary pointing menu" style="display:inline-flex;">
            <a class="item {{if activeTabInteract "active"}}" data-tab="tab-interact" onclick={{action "activateInteract"}}>Interact</a>
            <!--<a class="item {{if activeTabFiles "active"}}" data-tab="tab-files" onclick={{action "activateFiles"}}>Files</a>-->
            <a class="item {{if activeTabMetadata "active"}}" data-tab="tab-metadata" onclick={{action "activateMetadata"}}>Metadata</a>
        </div>
        <div class="ui tab {{if activeTabInteract "active"}}" data-tab="tab-interact">
            {{#if activeTabInteract}}
              {{#if (not-eq model.status 0)}}
                  {{#unless model.iframe}}
                      <div class="placeholder message">
                          <p>The compute environment for this Tale must run in a separate browser window.<br/>
                            <a class="ui primary button huge" href="{{model.url}}" target="_blank">Go to new window</a></p>
        
                      </div>
                  {{else}}
                    <div class="rounded-bottom" style="padding: 0; margin: 0; overflow-y: hidden;">
                      <iframe id="frontendDisplay"
                              src="{{model.url}}"
                              style="padding: 0; width:100%; height: inherit;"
                              class="ui basic segment">
                      </iframe>
                    </div>
                  {{/unless}}
              {{else}}
                <div class="placeholder message">
                  <p>Creating your new Tale...</p>
                </div>
              {{/if}}
            {{/if}}
        </div>
        <div class="ui tab {{if activeTabFiles "active"}}" data-tab="tab-files">
            {{#if activeTabFiles}}
               <div class="main-row">
                    <div class="ui grid">
                        <div class="five wide column">
                            {{#if currentFolderId}}
                                {{input type="file" value=file class="nice upload hidden" multiple=true}}
                            {{/if}}
                        </div>
                        <div class="eleven wide column">
                            {{ui/files/bread-crumbs currentNav=currentNav currentBreadCrumb=currentBreadCrumb fileBreadCrumbs=fileBreadCrumbs isMain=true navClicked="navClicked" bcClicked="breadcrumbClicked"}}
                        </div>
                    </div>
                </div>
            
                <div class="ui grid">
                    <div class="five wide column folder-navigator-container">
                        <div class="ui collapsable grid folder-grid">
                          {{ui/files/folder-navigator currentNavCommand=currentNavCommand openUploadDialog="openUploadDialog" openCreateFolderModal="openCreateFolderModal" onRegisterDataset="openRegisterModal" navClicked="navClicked"}}
                        </div>
                    </div>
                    <div class="eleven wide column">
                        <div class="ui collapsable grid" style="margin-left: 10px">
                            <div class="sixteen wide right aligned column">
                              {{ui/files/directory-browser currentNav=currentNav folderList=fileData.folderContents fileList=fileData.itemContents onItemClicked=(action 'itemClicked')}}
                            </div>
                            <div class="sixteen wide column overlay">
                              {{#unless currentBreadCrumb.isCollection}}
                                {{ui/files/nice-dropzone folderId=currentFolderId refresh=(action 'refresh')}}
                              {{/unless}}
                            </div>
                        </div>
                    </div>
                </div>
            {{/if}}
        </div>
        <div class="ui tab {{if activeTabMetadata "active"}}" data-tab="tab-metadata" style="overflow-x:auto;max-height:50vh;">
            {{#if activeTabMetadata}}
                <div class="ui form">
                  <div class="inline fields ui grid">
                    <label class="two wide column right aligned">Title</label>
                    <div class="field thirteen wide column">
                        {{input value=model.tale.title placeholder="Enter a title..." readonly=cannotEditTale}}
                    </div>
                  </div>
                  
                  <div class="inline fields ui grid">
                    <label class="two wide column right aligned">Authors</label>
                    <div class="field thirteen wide column">
                        {{input value=model.tale.authors placeholder="Enter the author's name..." readonly="true"}}
                    </div>
                  </div>
                  
                  <div class="inline fields ui grid">
                    <label class="two wide column right aligned">Category</label>
                    <div class="field thirteen wide column">
                        {{input value=model.tale.category placeholder="Choose a category..."  readonly=cannotEditTale}}
                    </div>
                  </div>
                  
                  <div class="inline fields ui grid">
                    <label class="two wide column right aligned">Environment</label>
                    <div class="field thirteen wide column">
                      <select class="ui dropdown" onchange={{action "setTaleEnvironment" value="target.value"}}>
                        <option disabled selected={{eq model.tale.imageId null}}>Choose an environment...</option>
                        {{#each environments as |env|}}
                          <option selected={{eq model.tale.imageId env._id}} value="{{env._id}}">
                              <img src="{{env.icon}}" />
                              {{ env.name }}
                          </option>
                        {{/each}}
                      </select>
                    </div>
                  </div>
                  
                  <div class="inline fields ui grid">
                    <label class="two wide column right aligned">Date Created</label>
                    <div class="field thirteen wide column">
                        {{input value=model.tale.created readonly="true"}}
                    </div>
                  </div>
                  
                  <div class="inline fields ui grid">
                    <label class="two wide column right aligned">Last Updated</label>
                    <div class="field thirteen wide column">
                      {{input value=model.tale.updated readonly="true"}}
                    </div>
                  </div>
                  
                  <div class="inline fields ui grid">
                      <label class="two wide column right aligned">Description</label>
                      <div class="thirteen wide column">
                        {{ui/markdown-editor markdownValue=model.tale.description}}
                      </div>
                  </div>
                  
                  <div class="inline fields ui grid">
                    <label class="two wide column right aligned">Illustration</label>
                    <div class="ui action field thirteen wide column">
                        {{input type="text" id="tale-icon" placeholder="Tale Icon" value=model.tale.illustration readonly=cannotEditTale }}
                        <div class="ui buttons">
                            <style type="text/css">
                                .or:before {
                                    color: rgba(0, 0, 0, 0.7) !important;
                                    font-size: 1.5em;
                                    margin-left: -5px;
                                }
                            </style>
                            <div class="or"></div>
                            <button class="ui positive blue button" {{action "generateIcon" model.tale}}>Generate Illustration</button>
                        </div>
                    </div>
                  </div>
                
                  <div class="inline fields ui grid">
                      <div class="field two wide column">
                      </div>
                      <div class="field two wide column">
                        <button {{action 'updateTale'}} class="ui blue submit button" type="submit"
                            disabled={{cannotEditTale}}>Save</button>
                      </div>
                      <div class="field toggle ui checkbox four wide column">
                          {{ui-checkbox class="toggle" label="Public?" checked=model.public onChange=(action (mut model.tale.public)) disabled=cannotEditTale}}
                      </div>
                  </div>
                </div>
            {{/if}}
        </div>
    {{else}}
        <div class="placeholder message">
            <p>Choose from
                <br/>Launched Tales panel
            </p>
        </div>
    {{/if}}

    {{!-- <div class="ui {{model._id}} modal" style="display: none">
        <i class="close icon"></i>
        <div class="header">
            Really Delete Instance?
        </div>
        <div class="image content">
            <div class="description">
                <p>This will permanently delete the '{{model.name}}' instance. Continue?</p>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button" {{action 'denyDelete'}}>
                No
            </div>
            <div class="ui positive right labeled icon button" {{action 'approveDelete' model}}>
                Yes
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div> --}}

    <div class="ui dataone modal" style="display: none">
        <i class="close icon"></i>
        <div class="header">
            Log into DataONE
        </div>
        <div class="image content">
            <div class="description">
                <p>In order to publish your Tale, you must first log into DataONE. Continuing will 
                    redirect you to the DataONE login page.
                </p>
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button" {{action 'denyDataONE'}}>
                Cancel
            </div>
            <div class="ui positive right labeled icon button" {{action 'authenticateD1' model._id}}>
                Continue to DataOne Login
                <i class="checkmark icon"></i>
            </div>
        </div>
    </div>
</div>
